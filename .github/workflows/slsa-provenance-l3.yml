name: SLSA L3 Provenance

# Triggered after build workflow completes
on:
  workflow_run:
    workflows: ["SLSA Build & SBOM"]
    types:
      - completed
    branches: [main]

permissions:
  contents: read
  packages: write
  id-token: write
  actions: read

env:
  REGISTRY: ghcr.io

jobs:
  # ===========================================================================
  # Collect build metadata from previous workflow
  # ===========================================================================
  collect:
    name: Collect Build Metadata
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    outputs:
      python_39: ${{ steps.check.outputs.python_39 }}
      python_310: ${{ steps.check.outputs.python_310 }}
      python_311: ${{ steps.check.outputs.python_311 }}
      python_312: ${{ steps.check.outputs.python_312 }}
      python_313: ${{ steps.check.outputs.python_313 }}
      python_314: ${{ steps.check.outputs.python_314 }}
      # Image repos and digests
      image_39: ${{ steps.metadata.outputs.image_39 }}
      digest_39: ${{ steps.metadata.outputs.digest_39 }}
      image_310: ${{ steps.metadata.outputs.image_310 }}
      digest_310: ${{ steps.metadata.outputs.digest_310 }}
      image_311: ${{ steps.metadata.outputs.image_311 }}
      digest_311: ${{ steps.metadata.outputs.digest_311 }}
      image_312: ${{ steps.metadata.outputs.image_312 }}
      digest_312: ${{ steps.metadata.outputs.digest_312 }}
      image_313: ${{ steps.metadata.outputs.image_313 }}
      digest_313: ${{ steps.metadata.outputs.digest_313 }}
      image_314: ${{ steps.metadata.outputs.image_314 }}
      digest_314: ${{ steps.metadata.outputs.digest_314 }}

    steps:
      - name: Download all build metadata artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          pattern: build-metadata-*
          path: metadata
          merge-multiple: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Check which images were built
        id: check
        run: |
          # Check for each Python version
          for ver in 39 310 311 312 313 314; do
            pattern="python-${ver:0:1}-${ver:1}"
            if ls metadata/*${pattern}*.json 2>/dev/null | head -1; then
              echo "python_${ver}=true" >> $GITHUB_OUTPUT
            else
              echo "python_${ver}=false" >> $GITHUB_OUTPUT
            fi
          done

      - name: Extract metadata
        id: metadata
        run: |
          for ver in 39 310 311 312 313 314; do
            pattern="python-${ver:0:1}-${ver:1}"
            file=$(ls metadata/*${pattern}*.json 2>/dev/null | head -1 || echo "")
            if [ -n "$file" ] && [ -f "$file" ]; then
              image=$(jq -r '.image_repo' "$file")
              digest=$(jq -r '.digest' "$file")
              echo "image_${ver}=${image}" >> $GITHUB_OUTPUT
              echo "digest_${ver}=${digest}" >> $GITHUB_OUTPUT
            else
              echo "image_${ver}=" >> $GITHUB_OUTPUT
              echo "digest_${ver}=" >> $GITHUB_OUTPUT
            fi
          done

  # ===========================================================================
  # SLSA L3 Provenance - Python 3.9
  # ===========================================================================
  provenance-39:
    needs: collect
    if: needs.collect.outputs.python_39 == 'true'
    permissions:
      actions: read
      id-token: write
      packages: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.1.0
    with:
      image: ${{ needs.collect.outputs.image_39 }}
      digest: ${{ needs.collect.outputs.digest_39 }}
      registry-username: ${{ github.actor }}
    secrets:
      registry-password: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # SLSA L3 Provenance - Python 3.10
  # ===========================================================================
  provenance-310:
    needs: collect
    if: needs.collect.outputs.python_310 == 'true'
    permissions:
      actions: read
      id-token: write
      packages: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.1.0
    with:
      image: ${{ needs.collect.outputs.image_310 }}
      digest: ${{ needs.collect.outputs.digest_310 }}
      registry-username: ${{ github.actor }}
    secrets:
      registry-password: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # SLSA L3 Provenance - Python 3.11
  # ===========================================================================
  provenance-311:
    needs: collect
    if: needs.collect.outputs.python_311 == 'true'
    permissions:
      actions: read
      id-token: write
      packages: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.1.0
    with:
      image: ${{ needs.collect.outputs.image_311 }}
      digest: ${{ needs.collect.outputs.digest_311 }}
      registry-username: ${{ github.actor }}
    secrets:
      registry-password: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # SLSA L3 Provenance - Python 3.12
  # ===========================================================================
  provenance-312:
    needs: collect
    if: needs.collect.outputs.python_312 == 'true'
    permissions:
      actions: read
      id-token: write
      packages: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.1.0
    with:
      image: ${{ needs.collect.outputs.image_312 }}
      digest: ${{ needs.collect.outputs.digest_312 }}
      registry-username: ${{ github.actor }}
    secrets:
      registry-password: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # SLSA L3 Provenance - Python 3.13
  # ===========================================================================
  provenance-313:
    needs: collect
    if: needs.collect.outputs.python_313 == 'true'
    permissions:
      actions: read
      id-token: write
      packages: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.1.0
    with:
      image: ${{ needs.collect.outputs.image_313 }}
      digest: ${{ needs.collect.outputs.digest_313 }}
      registry-username: ${{ github.actor }}
    secrets:
      registry-password: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # SLSA L3 Provenance - Python 3.14
  # ===========================================================================
  provenance-314:
    needs: collect
    if: needs.collect.outputs.python_314 == 'true'
    permissions:
      actions: read
      id-token: write
      packages: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.1.0
    with:
      image: ${{ needs.collect.outputs.image_314 }}
      digest: ${{ needs.collect.outputs.digest_314 }}
      registry-username: ${{ github.actor }}
    secrets:
      registry-password: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Verify with SLSA Verifier
  # ===========================================================================
  verify:
    name: Verify L3 Provenance
    needs: [collect, provenance-39, provenance-310, provenance-311, provenance-312, provenance-313, provenance-314]
    if: always() && needs.collect.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Install slsa-verifier
        uses: slsa-framework/slsa-verifier/actions/installer@3714a2a4684014deb874a0e737dffa0ee02dd647 # v2.7.0

      - name: Log in to GHCR
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify Python 3.9
        if: needs.collect.outputs.python_39 == 'true' && needs.provenance-39.result == 'success'
        run: |
          slsa-verifier verify-image "${{ needs.collect.outputs.image_39 }}@${{ needs.collect.outputs.digest_39 }}" \
            --source-uri github.com/${{ github.repository }}

      - name: Verify Python 3.10
        if: needs.collect.outputs.python_310 == 'true' && needs.provenance-310.result == 'success'
        run: |
          slsa-verifier verify-image "${{ needs.collect.outputs.image_310 }}@${{ needs.collect.outputs.digest_310 }}" \
            --source-uri github.com/${{ github.repository }}

      - name: Verify Python 3.11
        if: needs.collect.outputs.python_311 == 'true' && needs.provenance-311.result == 'success'
        run: |
          slsa-verifier verify-image "${{ needs.collect.outputs.image_311 }}@${{ needs.collect.outputs.digest_311 }}" \
            --source-uri github.com/${{ github.repository }}

      - name: Verify Python 3.12
        if: needs.collect.outputs.python_312 == 'true' && needs.provenance-312.result == 'success'
        run: |
          slsa-verifier verify-image "${{ needs.collect.outputs.image_312 }}@${{ needs.collect.outputs.digest_312 }}" \
            --source-uri github.com/${{ github.repository }}

      - name: Verify Python 3.13
        if: needs.collect.outputs.python_313 == 'true' && needs.provenance-313.result == 'success'
        run: |
          slsa-verifier verify-image "${{ needs.collect.outputs.image_313 }}@${{ needs.collect.outputs.digest_313 }}" \
            --source-uri github.com/${{ github.repository }}

      - name: Verify Python 3.14
        if: needs.collect.outputs.python_314 == 'true' && needs.provenance-314.result == 'success'
        run: |
          slsa-verifier verify-image "${{ needs.collect.outputs.image_314 }}@${{ needs.collect.outputs.digest_314 }}" \
            --source-uri github.com/${{ github.repository }}

      - name: Generate verification summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## SLSA Build L3 Verification Summary

          | Image | Provenance | Verified |
          |-------|------------|----------|
          EOF

          for ver in 39 310 311 312 313 314; do
            case $ver in
              39) image="${{ needs.collect.outputs.image_39 }}"; prov="${{ needs.provenance-39.result }}" ;;
              310) image="${{ needs.collect.outputs.image_310 }}"; prov="${{ needs.provenance-310.result }}" ;;
              311) image="${{ needs.collect.outputs.image_311 }}"; prov="${{ needs.provenance-311.result }}" ;;
              312) image="${{ needs.collect.outputs.image_312 }}"; prov="${{ needs.provenance-312.result }}" ;;
              313) image="${{ needs.collect.outputs.image_313 }}"; prov="${{ needs.provenance-313.result }}" ;;
              314) image="${{ needs.collect.outputs.image_314 }}"; prov="${{ needs.provenance-314.result }}" ;;
            esac
            if [ -n "$image" ]; then
              status="${prov:-skipped}"
              echo "| Python ${ver:0:1}.${ver:1} | $status | $([[ "$status" == "success" ]] && echo "Yes" || echo "N/A") |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          ### Verify Locally with slsa-verifier
          ```bash
          slsa-verifier verify-image "ghcr.io/santoshkal/fips-images/<image-name>@sha256:..." \
            --source-uri github.com/santoshkal/fips-images
          ```
          EOF
